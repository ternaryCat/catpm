<% content_for :title, @target %>
<% content_for :subtitle do %>
  <%= type_badge(@kind) %>
  <%= @target %> <%= @operation.presence %>
  &middot; <%= @count %> requests
  &middot; <%= @range == "all" ? "All time" : range_label(@range) %>
<% end %>

<%= render "catpm/shared/page_nav", active: "performance" %>

<div class="breadcrumbs" style="display:flex; align-items:center; justify-content:space-between">
  <div>
    <a href="<%= catpm.status_index_path %>">Performance</a>
    <span class="sep">/</span>
    <span><%= @target %></span>
  </div>
  <%= button_to "Delete Endpoint", catpm.endpoint_path(kind: @kind, target: @target, operation: @operation),
      method: :delete, class: "btn btn-danger",
      data: { confirm: "Delete this endpoint and all its data? This cannot be undone." } %>
</div>

<% ep_params = { kind: @kind, target: @target, operation: @operation } %>
<div class="time-range">
  <% (["all"] + Catpm::ApplicationHelper::RANGE_KEYS).each do |r| %>
    <a href="<%= catpm.endpoint_path(ep_params.merge(range: r)) %>" class="<%= 'active' if @range == r %>"><%= r == "all" ? "All" : r %></a>
  <% end %>
</div>

<div class="grid">
  <div class="card">
    <div class="label">Requests</div>
    <div class="value"><%= @count %></div>
  </div>
  <div class="card">
    <div class="label">First Event</div>
    <div class="value"><%= @first_event_at ? time_with_tooltip(@first_event_at) : "—" %></div>
  </div>
  <div class="card">
    <div class="label">Last Event</div>
    <div class="value"><%= @last_event_at ? time_with_tooltip(@last_event_at) : "—" %></div>
  </div>
  <div class="card">
    <div class="label">Max</div>
    <div class="value"><%= format_duration(@duration_max) %></div>
  </div>
  <div class="card">
    <div class="label">Min</div>
    <div class="value"><%= format_duration(@duration_min) %></div>
  </div>
  <div class="card">
    <div class="label">Failures</div>
    <div class="value"><%= @failure_count %></div>
    <div class="detail"><%= "%.1f" % (@failure_rate * 100) %>%</div>
  </div>
</div>

<% if @tdigest && @tdigest.count > 0 %>
  <h2>Percentile Distribution</h2>
  <%= section_description("p95 means 95% of requests completed faster than this value. Higher percentiles reveal tail latency.") %>
  <div class="grid">
    <% [0.5, 0.75, 0.9, 0.95, 0.99].each do |p| %>
      <div class="card">
        <div class="label">p<%= (p * 100).to_i %></div>
        <div class="value"><%= format_duration(@tdigest.percentile(p)) %></div>
      </div>
    <% end %>
  </div>
<% end %>

<%
  type_data = segment_colors.map { |type, color|
    count = (@metadata["#{type}_count"] || @metadata[:"#{type}_count"] || 0).to_f
    dur = (@metadata["#{type}_duration"] || @metadata[:"#{type}_duration"] || 0).to_f
    avg_dur = @count > 0 ? dur / @count : 0
    avg_count = @count > 0 ? count / @count : 0
    text_color = segment_text_colors[type] || "#4b5563"
    { type: type, label: segment_labels[type] || type.capitalize, bg: color, text: text_color, count: count, dur: dur, avg_dur: avg_dur, avg_count: avg_count }
  }.select { |d| d[:count] > 0 }
%>

<% if type_data.any? %>
  <h2>Average Time Breakdown</h2>

  <%
    avg_total = @avg_duration
    typed_avg = type_data.sum { |d| d[:avg_dur] }
    avg_other = [avg_total - typed_avg, 0].max
    bar_data = type_data.map { |d| [d[:label], d[:avg_dur], d[:bg], d[:text]] }
    bar_data << ["Other", avg_other, "#dde2e8", "#4b5563"] if avg_other > 0
  %>

  <div style="margin-bottom:16px">
    <div style="display:flex; height:32px; border-radius:4px; overflow:hidden; border:1px solid var(--border)">
      <% bar_data.each do |label, dur, bg, text| %>
        <% if dur > 0 && avg_total > 0 %>
          <div title="<%= label %> — <%= format_duration(dur) %> (<%= "%.0f" % (dur/avg_total*100) %>%)" style="flex:<%= dur %>; background:<%= bg %>; display:flex; align-items:center; justify-content:center; color:<%= text %>; font-size:11px; font-weight:500; overflow:hidden; white-space:nowrap; padding:0 4px;">
            <% if dur / avg_total > 0.08 %><%= label %><% end %>
          </div>
        <% end %>
      <% end %>
    </div>
    <div style="display:flex; gap:14px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:var(--text-1)">
      <% bar_data.each do |label, dur, bg, text| %>
        <span><span style="display:inline-block;width:10px;height:10px;background:<%= bg %>;border-radius:2px;margin-right:4px;border:1px solid <%= text %>22"></span><%= label %> <%= format_duration(dur) %> (<%= "%.0f" % (avg_total > 0 ? dur/avg_total*100 : 0) %>%)</span>
      <% end %>
    </div>
  </div>

<% end %>

<% has_requests = @chart_requests&.any? { |v| v > 0 } %>
<% has_errors = @chart_errors&.any? { |v| v > 0 } %>
<% has_durations = @chart_durations&.any? { |v| v > 0 } %>
<% if has_requests || has_errors || has_durations %>
  <div class="charts-row">
    <% if has_requests %>
      <div class="chart-card">
        <div class="label">Request Volume</div>
        <div class="value"><%= @chart_requests.sum %></div>
        <div class="detail"><%= range_label(@range) %></div>
        <div class="sparkline"><%= sparkline_svg(@chart_requests, width: 500, height: 64, color: "var(--accent)", fill: true, time_labels: @chart_times) %></div>
      </div>
    <% end %>
    <% if has_errors %>
      <div class="chart-card">
        <div class="label">Error Volume</div>
        <div class="value"><%= @chart_errors.sum %></div>
        <div class="detail"><%= range_label(@range) %></div>
        <div class="sparkline"><%= sparkline_svg(@chart_errors, width: 500, height: 64, color: "var(--red)", fill: true, time_labels: @chart_times) %></div>
      </div>
    <% end %>
    <% if has_durations %>
      <div class="chart-card">
        <div class="label">Avg Duration</div>
        <% nonzero = @chart_durations.select { |v| v > 0 } %>
        <div class="value"><%= nonzero.any? ? format_duration(nonzero.sum / nonzero.size) : "—" %></div>
        <div class="detail"><%= range_label(@range) %></div>
        <div class="sparkline"><%= sparkline_svg(@chart_durations, width: 500, height: 64, color: "var(--accent)", fill: true, labels: @chart_durations.map { |d| format_duration(d) }, time_labels: @chart_times) %></div>
      </div>
    <% end %>
  </div>
<% end %>

<%= render "catpm/endpoints/sample_table", title: "Error Requests", samples: @error_samples, empty_msg: "No errors for this endpoint." %>
<%= render "catpm/endpoints/sample_table", title: "Slowest Requests", samples: @slow_samples, empty_msg: "No slow requests captured yet." %>
<%= render "catpm/endpoints/sample_table", title: "Sample Requests", samples: @samples, empty_msg: "No samples captured yet." %>
