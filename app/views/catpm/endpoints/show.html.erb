<% content_for :title, @target %>
<% content_for :subtitle do %>
  <span class="badge badge-<%= @kind %>"><%= @kind %></span>
  <strong><%= @target %></strong> <%= @operation.presence %>
  &middot; <%= @count %> requests
<% end %>

<%# ─── Stats Cards ─── %>
<div class="grid">
  <div class="card">
    <div class="label">Requests</div>
    <div class="value green"><%= @count %></div>
  </div>
  <div class="card">
    <div class="label">Avg Duration</div>
    <div class="value"><%= "%.1f" % @avg_duration %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">p95</div>
    <div class="value yellow"><%= @tdigest ? ("%.1f" % @tdigest.percentile(0.95)) : "—" %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">Max</div>
    <div class="value red"><%= "%.1f" % @duration_max %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">Min</div>
    <div class="value"><%= "%.1f" % @duration_min %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">Failures</div>
    <div class="value <%= @failure_count > 0 ? 'red' : '' %>"><%= @failure_count %></div>
    <div class="detail"><%= "%.1f" % (@failure_rate * 100) %>%</div>
  </div>
</div>

<%# ─── Percentile Distribution ─── %>
<% if @tdigest && @tdigest.count > 0 %>
  <h2>Percentile Distribution</h2>
  <div class="grid">
    <% [0.5, 0.75, 0.9, 0.95, 0.99].each do |p| %>
      <div class="card">
        <div class="label">p<%= (p * 100).to_i %></div>
        <div class="value"><%= "%.1f" % @tdigest.percentile(p) %><span style="font-size:14px;color:#8b949e">ms</span></div>
      </div>
    <% end %>
  </div>
<% end %>

<%# ─── Time Breakdown ─── %>
<%
  segment_colors = { "sql" => "#1f6feb", "view" => "#8957e5", "cache" => "#3fb950", "http" => "#da3633", "mailer" => "#d2a8ff", "storage" => "#56d364", "custom" => "#f0883e" }
  segment_labels = { "sql" => "SQL queries", "view" => "View renders", "cache" => "Cache ops", "http" => "HTTP calls", "mailer" => "Mailer", "storage" => "Storage", "custom" => "Custom traces" }
  type_data = segment_colors.map { |type, color|
    count = (@metadata["#{type}_count"] || @metadata[:"#{type}_count"] || 0).to_f
    dur = (@metadata["#{type}_duration"] || @metadata[:"#{type}_duration"] || 0).to_f
    avg_dur = @count > 0 ? dur / @count : 0
    avg_count = @count > 0 ? count / @count : 0
    { type: type, label: segment_labels[type], color: color, count: count, dur: dur, avg_dur: avg_dur, avg_count: avg_count }
  }.select { |d| d[:count] > 0 }
%>

<% if type_data.any? %>
  <h2>Average Time Breakdown</h2>

  <%
    avg_total = @avg_duration
    typed_avg = type_data.sum { |d| d[:avg_dur] }
    avg_other = [avg_total - typed_avg, 0].max
    bar_data = type_data.map { |d| [d[:label], d[:avg_dur], d[:color]] }
    bar_data << ["Other", avg_other, "#484f58"] if avg_other > 0
  %>

  <div style="margin-bottom: 16px">
    <div style="display:flex; height:32px; border-radius:6px; overflow:hidden;">
      <% bar_data.each do |label, dur, color| %>
        <% if dur > 0 && avg_total > 0 %>
          <div style="flex:<%= dur %>; background:<%= color %>; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; overflow:hidden; white-space:nowrap; padding:0 4px;">
            <% if dur / avg_total > 0.08 %><%= label %> <%= "%.0f" % (dur / avg_total * 100) %>%<% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="grid">
    <% type_data.each do |d| %>
      <div class="card">
        <div class="label">Avg <%= d[:label] %></div>
        <div class="value"><%= "%.0f" % d[:avg_count] %></div>
        <div class="detail"><%= "%.1f" % d[:avg_dur] %>ms avg</div>
      </div>
    <% end %>
    <div class="card">
      <div class="label">Avg Other</div>
      <div class="value"><%= "%.1f" % avg_other %><span style="font-size:14px;color:#8b949e">ms</span></div>
      <div class="detail">app code, middleware</div>
    </div>
  </div>
<% end %>

<%= render "catpm/endpoints/sample_table", title: "Slowest Requests", samples: @slow_samples, empty_msg: "No slow requests captured." %>
<%= render "catpm/endpoints/sample_table", title: "Sample Requests", samples: @samples, empty_msg: "No samples yet. First requests will be captured automatically." %>
<%= render "catpm/endpoints/sample_table", title: "Error Requests", samples: @error_samples, empty_msg: "No errors." %>
