<% content_for :title, @target %>
<% content_for :subtitle do %>
  <span class="badge badge-<%= @kind %>"><%= @kind %></span>
  <strong><%= @target %></strong> <%= @operation.presence %>
  &middot; <%= @count %> requests
<% end %>

<%# ─── Stats Cards ─── %>
<div class="grid">
  <div class="card">
    <div class="label">Requests</div>
    <div class="value green"><%= @count %></div>
  </div>
  <div class="card">
    <div class="label">Avg Duration</div>
    <div class="value"><%= "%.1f" % @avg_duration %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">p95</div>
    <div class="value yellow"><%= @tdigest ? ("%.1f" % @tdigest.percentile(0.95)) : "—" %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">Max</div>
    <div class="value red"><%= "%.1f" % @duration_max %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">Min</div>
    <div class="value"><%= "%.1f" % @duration_min %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <div class="card">
    <div class="label">Failures</div>
    <div class="value <%= @failure_count > 0 ? 'red' : '' %>"><%= @failure_count %></div>
    <div class="detail"><%= "%.1f" % (@failure_rate * 100) %>%</div>
  </div>
</div>

<%# ─── Percentile Distribution ─── %>
<% if @tdigest && @tdigest.count > 0 %>
  <h2>Percentile Distribution</h2>
  <div class="grid">
    <% [0.5, 0.75, 0.9, 0.95, 0.99].each do |p| %>
      <div class="card">
        <div class="label">p<%= (p * 100).to_i %></div>
        <div class="value"><%= "%.1f" % @tdigest.percentile(p) %><span style="font-size:14px;color:#8b949e">ms</span></div>
      </div>
    <% end %>
  </div>
<% end %>

<%# ─── Time Breakdown ─── %>
<% sql_count = (@metadata["sql_count"] || @metadata[:sql_count] || 0).to_f %>
<% sql_dur = (@metadata["sql_duration"] || @metadata[:sql_duration] || 0).to_f %>
<% view_count = (@metadata["view_count"] || @metadata[:view_count] || 0).to_f %>
<% view_dur = (@metadata["view_duration"] || @metadata[:view_duration] || 0).to_f %>

<% if sql_count > 0 || view_count > 0 %>
  <h2>Average Time Breakdown</h2>

  <% avg_total = @avg_duration %>
  <% avg_sql = @count > 0 ? sql_dur / @count : 0 %>
  <% avg_view = @count > 0 ? view_dur / @count : 0 %>
  <% avg_other = [avg_total - avg_sql - avg_view, 0].max %>

  <% sql_pct = avg_total > 0 ? (avg_sql / avg_total * 100) : 0 %>
  <% view_pct = avg_total > 0 ? (avg_view / avg_total * 100) : 0 %>
  <% other_pct = [100 - sql_pct - view_pct, 0].max %>

  <div style="margin-bottom: 16px">
    <div style="display:flex; height:32px; border-radius:6px; overflow:hidden; gap:1px;">
      <% if sql_pct > 0 %>
        <div style="width:<%= sql_pct %>%; background:#1f6feb; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; min-width:40px;">
          SQL <%= "%.0f" % sql_pct %>%
        </div>
      <% end %>
      <% if view_pct > 0 %>
        <div style="width:<%= view_pct %>%; background:#8957e5; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; min-width:40px;">
          View <%= "%.0f" % view_pct %>%
        </div>
      <% end %>
      <% if other_pct > 0 %>
        <div style="width:<%= other_pct %>%; background:#484f58; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; min-width:40px;">
          Other <%= "%.0f" % other_pct %>%
        </div>
      <% end %>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">Avg SQL queries</div>
      <div class="value"><%= "%.0f" % (@count > 0 ? sql_count / @count : 0) %></div>
      <div class="detail"><%= "%.1f" % avg_sql %>ms avg</div>
    </div>
    <div class="card">
      <div class="label">Avg View renders</div>
      <div class="value"><%= "%.0f" % (@count > 0 ? view_count / @count : 0) %></div>
      <div class="detail"><%= "%.1f" % avg_view %>ms avg</div>
    </div>
    <div class="card">
      <div class="label">Avg Other</div>
      <div class="value"><%= "%.1f" % avg_other %><span style="font-size:14px;color:#8b949e">ms</span></div>
      <div class="detail">app code, middleware</div>
    </div>
  </div>
<% end %>

<%= render "catpm/endpoints/sample_table", title: "Slowest Requests", samples: @slow_samples, empty_msg: "No slow requests captured." %>
<%= render "catpm/endpoints/sample_table", title: "Sample Requests", samples: @samples, empty_msg: "No samples yet. First requests will be captured automatically." %>
<%= render "catpm/endpoints/sample_table", title: "Error Requests", samples: @error_samples, empty_msg: "No errors." %>
