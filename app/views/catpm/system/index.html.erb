<% content_for :title, "System" %>
<% content_for :subtitle, "Diagnostics & Configuration" %>

<%= render "catpm/shared/page_nav", active: "system" %>

<%# ─── Runtime Diagnostics ─── %>
<h2>Runtime</h2>

<div class="diag-grid">
  <div class="diag-card">
    <div class="diag-label">Buffer</div>
    <div class="diag-value"><%= @buffer_size %> <span class="diag-unit">events</span></div>
    <div class="diag-detail"><%= number_to_human_size(@buffer_bytes) %> / <%= number_to_human_size(@config.max_buffer_memory) %></div>
  </div>
  <div class="diag-card">
    <div class="diag-label">Flushes</div>
    <div class="diag-value"><%= @stats[:flushes] %></div>
    <div class="diag-detail">every ~<%= @config.flush_interval %>s</div>
  </div>
  <div class="diag-card">
    <div class="diag-label">Drops</div>
    <div class="diag-value<%= @stats[:dropped_events] > 0 ? " diag-value--warn" : "" %>"><%= @stats[:dropped_events] %></div>
    <div class="diag-detail"><% if @stats[:dropped_events] > 0 %>buffer was full<% else %><span class="pulse" style="background:var(--green)"></span> none<% end %></div>
  </div>
  <div class="diag-card">
    <div class="diag-label">Circuit</div>
    <div class="diag-value<%= @stats[:circuit_opens] > 0 ? " diag-value--warn" : "" %>"><% if @stats[:circuit_opens] > 0 %><%= @stats[:circuit_opens] %> opens<% else %>healthy<% end %></div>
    <div class="diag-detail"><% if @stats[:circuit_opens] > 0 %>DB write failures<% else %><span class="pulse" style="background:var(--green)"></span> no failures<% end %></div>
  </div>
  <div class="diag-card">
    <div class="diag-label">Data</div>
    <div class="diag-value"><%= @oldest_bucket ? @oldest_bucket.strftime('%b %-d') : "—" %></div>
    <div class="diag-detail"><%= @oldest_bucket ? "retained #{@config.retention_period ? "#{(@config.retention_period / 1.day).to_i} days" : "forever"}" : "no data yet" %></div>
  </div>
</div>

<%# ─── Storage ─── %>
<% total_bytes = @table_sizes.sum { |t| t[:total_bytes].to_i } %>
<% has_bytes = @table_sizes.any? { |t| t[:total_bytes] } %>
<% total_rows = @table_sizes.sum { |t| t[:row_estimate].to_i } %>
<% max_rows = @table_sizes.map { |t| t[:row_estimate].to_i }.max %>
<% max_rows = 1 if max_rows == 0 %>

<h2>Storage</h2>

<div class="storage-card">
  <div class="storage-header">
    <% if has_bytes %>
      <span class="storage-total"><%= number_to_human_size(total_bytes) %></span>
      <span class="storage-meta"><%= number_with_delimiter(total_rows) %> rows across <%= @table_sizes.size %> tables</span>
    <% else %>
      <span class="storage-total"><%= number_with_delimiter(total_rows) %> rows</span>
      <span class="storage-meta"><%= @table_sizes.size %> tables</span>
    <% end %>
  </div>
  <div class="storage-bars">
    <% @table_sizes.sort_by { |t| -t[:row_estimate].to_i }.each do |t| %>
      <% row_count = t[:row_estimate].to_i %>
      <% pct = (row_count.to_f / max_rows * 100).round(1) %>
      <div class="storage-row">
        <span class="storage-name mono"><%= t[:name].sub('catpm_', '') %></span>
        <div class="storage-bar-track">
          <div class="storage-bar-fill" style="width:<%= [pct, 2].max %>%"></div>
        </div>
        <span class="storage-row-stat mono"><%= number_with_delimiter(row_count) %></span>
        <% if has_bytes %>
          <span class="storage-row-size mono"><%= number_to_human_size(t[:total_bytes].to_i) %></span>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<%# ─── Configuration (grouped cards) ─── %>
<h2>Configuration</h2>
<%= section_description("Current runtime settings. Set via initializer — each row shows the config parameter name.") %>

<% Catpm::ApplicationHelper::CONFIG_METADATA.group_by { |_, m| m[:group] }.each do |group_name, settings| %>
  <% visible = settings.select { |_, m| config_condition_met?(m) } %>
  <% next if visible.empty? %>
  <div class="config-group">
    <h3 class="config-group-title"><%= group_name %></h3>
    <div class="config-group-body">
      <% visible.each do |attr, meta| %>
        <div class="config-item">
          <div class="config-item-header">
            <span class="config-item-label"><%= meta[:label] %></span>
            <span class="config-item-value mono"><%= format_config_value(@config, attr, meta) %></span>
          </div>
          <div class="config-item-meta">
            <code class="config-param">config.<%= attr %></code>
            <span class="config-desc"><%= meta[:desc] %></span>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
