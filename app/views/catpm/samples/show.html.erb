<% content_for :title, "Sample ##{@sample.id}" %>
<% content_for :subtitle do %>
  <%= type_badge(@sample.sample_type) %>
  <%= type_badge(@sample.kind) %>
  <%= @bucket&.target %>
  &middot; <%= format_duration(@sample.duration) %>
<% end %>

<div class="breadcrumbs" style="display:flex; align-items:center; justify-content:space-between">
  <div>
    <a href="<%= catpm.status_index_path %>">Overview</a>
    <% if @bucket %>
      <span class="sep">/</span>
      <a href="<%= catpm.endpoint_path(kind: @bucket.kind, target: @bucket.target, operation: @bucket.operation) %>"><%= @bucket.target %></a>
    <% end %>
    <span class="sep">/</span>
    <span>Sample #<%= @sample.id %></span>
  </div>
  <%= button_to "Delete Sample", catpm.sample_path(@sample),
      method: :delete, class: "btn btn-danger" %>
</div>

<%# ─── Request Info Bar ─── %>
<% method_val = @context["method"] || @context[:method] %>
<% path_val = @context["path"] || @context[:path] %>
<% status_val = @context["status"] || @context[:status] %>
<div class="request-bar">
  <% if method_val %><strong class="mono"><%= method_val %></strong><% end %>
  <% if path_val %><span class="mono"><%= path_val %></span><% end %>
  <% if status_val %><%= status_badge(status_val) %><% end %>
  <span class="sep">&middot;</span>
  <span class="mono"><%= format_duration(@sample.duration) %></span>
  <span class="sep">&middot;</span>
  <span class="text-muted"><%= time_with_tooltip(@sample.recorded_at) %></span>
  <% if @error_record %>
    <span class="sep">&middot;</span>
    <a href="<%= catpm.error_path(@error_record) %>" class="badge badge-error" style="text-decoration:none">Error: <%= @error_record.error_class %></a>
  <% end %>
</div>

<%# ─── Request Context ─── %>
<%
  ctx_display = @context.except("segments", :segments, "segment_summary", :segment_summary, "segments_capped", :segments_capped, "backtrace", :backtrace, "method", :method, "path", :path, "status", :status)
  ctx_flat = ctx_display.select { |_, v| !v.is_a?(Hash) && !v.is_a?(Array) }
  ctx_nested = ctx_display.select { |_, v| v.is_a?(Hash) || v.is_a?(Array) }
%>

<% if ctx_display.any? %>
  <h2>Request Context</h2>
  <% if ctx_flat.any? %>
    <div class="context-grid" style="margin-bottom:12px">
      <% ctx_flat.each do |k, v| %>
        <div class="ctx-key"><%= k %></div>
        <div class="ctx-val"><%= v.to_s.truncate(200) %></div>
      <% end %>
    </div>
  <% end %>
  <% if ctx_nested.any? %>
    <% ctx_nested.each do |k, v| %>
      <details class="collapsible" open>
        <summary><%= k %></summary>
        <div class="details-body">
          <pre class="mono" style="color:var(--text-1); white-space:pre-wrap; font-size:12px"><%= JSON.pretty_generate(v) rescue v.inspect %></pre>
        </div>
      </details>
    <% end %>
  <% end %>
<% end %>

<%# ─── Time Breakdown (full width, above waterfall) ─── %>
<% if @summary.any? %>
  <%
    breakdown = segment_colors.filter_map { |type, color|
      dur = (@summary["#{type}_duration"] || @summary[:"#{type}_duration"] || 0).to_f
      count = (@summary["#{type}_count"] || @summary[:"#{type}_count"] || 0).to_i
      next if dur <= 0
      next if (type == "code" || type == "other") && count <= 1 && dur < 1.0
      text_color = segment_text_colors[type] || "#4b5563"
      [segment_labels[type] || type.capitalize, dur, color, count, text_color]
    }
    typed_total = breakdown.sum { |_, dur, _, _, _| dur }
    other_dur = [@sample.duration - typed_total, 0].max
    breakdown << ["Other", other_dur, "#dde2e8", nil, "#4b5563"] if other_dur > 0.5
    total = @sample.duration
  %>

  <h2>Time Breakdown</h2>
  <div style="display:flex; height:32px; border-radius:4px; overflow:hidden; margin-bottom:4px; border:1px solid var(--border)">
    <% breakdown.each do |label, dur, color, _, text| %>
      <% if dur > 0 && total > 0 %>
        <div title="<%= label %> — <%= format_duration(dur) %> (<%= "%.0f" % (dur/total*100) %>%)" style="flex:<%= dur %>; background:<%= color %>; display:flex; align-items:center; justify-content:center; color:<%= text %>; font-size:11px; font-weight:500; overflow:hidden; white-space:nowrap; padding:0 4px;">
          <% if dur / total > 0.08 %><%= label %><% end %>
        </div>
      <% end %>
    <% end %>
  </div>
  <div style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:16px; font-size:12px; color:var(--text-1)">
    <% breakdown.each do |label, dur, color, count, text| %>
      <span><span style="display:inline-block;width:10px;height:10px;background:<%= color %>;border-radius:2px;margin-right:4px;border:1px solid <%= text %>22"></span><%= label %> <%= format_duration(dur) %> (<%= "%.0f" % (total > 0 ? dur/total*100 : 0) %>%)<%= " · #{count}" if count && count > 0 %></span>
    <% end %>
  </div>
<% end %>

<%# ─── Segments Waterfall (full width, no title) ─── %>
<% if @segments.any? %>
  <%= render "catpm/shared/segments_waterfall", segments: @segments, total_duration: @sample.duration, segments_capped: @context["segments_capped"] || @context[:segments_capped], table_id: "segments-table" %>
<% end %>
