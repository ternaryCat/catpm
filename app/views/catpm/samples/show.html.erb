<% content_for :title, "Request Detail" %>
<% content_for :subtitle do %>
  <span class="badge badge-<%= @sample.sample_type %>"><%= @sample.sample_type %></span>
  <span class="badge badge-<%= @sample.kind %>"><%= @sample.kind %></span>
  <strong><%= @bucket&.target %></strong>
  &middot; <%= "%.1f" % @sample.duration %>ms
  &middot; <%= @sample.recorded_at.strftime("%Y-%m-%d %H:%M:%S") %>
<% end %>

<%# ─── Request Info ─── %>
<div class="grid">
  <div class="card">
    <div class="label">Duration</div>
    <div class="value"><%= "%.1f" % @sample.duration %><span style="font-size:14px;color:#8b949e">ms</span></div>
  </div>
  <% if @summary.any? %>
    <div class="card">
      <div class="label">SQL Queries</div>
      <div class="value"><%= (@summary["sql_count"] || @summary[:sql_count] || 0).to_i %></div>
      <div class="detail"><%= "%.1f" % (@summary["sql_duration"] || @summary[:sql_duration] || 0).to_f %>ms total</div>
    </div>
    <div class="card">
      <div class="label">View Renders</div>
      <div class="value"><%= (@summary["view_count"] || @summary[:view_count] || 0).to_i %></div>
      <div class="detail"><%= "%.1f" % (@summary["view_duration"] || @summary[:view_duration] || 0).to_f %>ms total</div>
    </div>
  <% end %>
  <div class="card">
    <div class="label">Endpoint</div>
    <div class="value" style="font-size:16px"><%= @bucket&.target || "—" %></div>
  </div>
</div>

<%# ─── Request Context ─── %>
<% method_val = @context["method"] || @context[:method] %>
<% path_val = @context["path"] || @context[:path] %>
<% status_val = @context["status"] || @context[:status] %>
<% if method_val || path_val %>
  <h2>Request</h2>
  <div style="background:#161b22; border:1px solid #30363d; border-radius:8px; padding:14px; margin-bottom:12px">
    <span class="mono" style="color:#f0f6fc; font-size:14px">
      <strong><%= method_val %></strong> <%= path_val %>
    </span>
    <% if status_val %>
      <span class="badge" style="margin-left:8px; background:<%= status_val.to_i >= 400 ? '#3f1f1f' : '#1f3f2a' %>; color:<%= status_val.to_i >= 400 ? '#f85149' : '#3fb950' %>"><%= status_val %></span>
    <% end %>
  </div>
<% end %>

<%# ─── Time Breakdown Bar ─── %>
<% if @summary.any? %>
  <% sql_dur = (@summary["sql_duration"] || @summary[:sql_duration] || 0).to_f %>
  <% view_dur = (@summary["view_duration"] || @summary[:view_duration] || 0).to_f %>
  <% other_dur = [@sample.duration - sql_dur - view_dur, 0].max %>
  <% total = @sample.duration %>

  <h2>Time Breakdown</h2>
  <div style="display:flex; height:36px; border-radius:6px; overflow:hidden; margin-bottom:4px">
    <% if sql_dur > 0 && total > 0 %>
      <div style="flex:<%= sql_dur %>; background:#1f6feb; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; overflow:hidden; white-space:nowrap; padding:0 4px;">
        <% if sql_dur / total > 0.08 %>SQL <%= "%.1f" % sql_dur %>ms<% end %>
      </div>
    <% end %>
    <% if view_dur > 0 && total > 0 %>
      <div style="flex:<%= view_dur %>; background:#8957e5; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; overflow:hidden; white-space:nowrap; padding:0 4px;">
        <% if view_dur / total > 0.08 %>View <%= "%.1f" % view_dur %>ms<% end %>
      </div>
    <% end %>
    <% if other_dur > 0 && total > 0 %>
      <div style="flex:<%= other_dur %>; background:#484f58; display:flex; align-items:center; justify-content:center; color:#fff; font-size:11px; overflow:hidden; white-space:nowrap; padding:0 4px;">
        <% if other_dur / total > 0.08 %>Other <%= "%.1f" % other_dur %>ms<% end %>
      </div>
    <% end %>
  </div>
  <div style="display:flex; gap:16px; margin-bottom:16px; font-size:11px; color:#8b949e">
    <span><span style="display:inline-block;width:10px;height:10px;background:#1f6feb;border-radius:2px;margin-right:4px"></span>SQL <%= "%.1f" % sql_dur %>ms (<%= "%.0f" % (total > 0 ? sql_dur/total*100 : 0) %>%)</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#8957e5;border-radius:2px;margin-right:4px"></span>View <%= "%.1f" % view_dur %>ms (<%= "%.0f" % (total > 0 ? view_dur/total*100 : 0) %>%)</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#484f58;border-radius:2px;margin-right:4px"></span>Other <%= "%.1f" % other_dur %>ms (<%= "%.0f" % (total > 0 ? other_dur/total*100 : 0) %>%)</span>
  </div>
<% end %>

<%# ─── Segments Timeline ─── %>
<% if @segments.any? %>
  <h2>Segments (<%= @segments.size %><%= @context["segments_capped"] || @context[:segments_capped] ? " — capped" : "" %>)</h2>

  <% total_dur = @sample.duration %>
  <% total_dur = 1.0 if total_dur == 0 %>

  <div style="background:#161b22; border:1px solid #30363d; border-radius:8px; overflow:hidden">
    <table style="margin:0">
      <thead>
        <tr>
          <th style="width:40px">#</th>
          <th style="width:55px">Type</th>
          <th style="width:70px">Duration</th>
          <th style="width:60px">Offset</th>
          <th>Detail</th>
          <th style="width:35%">Timeline</th>
        </tr>
      </thead>
      <tbody>
        <% @segments.each_with_index do |seg, i| %>
          <% type = (seg["type"] || seg[:type]).to_s %>
          <% dur = (seg["duration"] || seg[:duration] || 0).to_f %>
          <% offset = (seg["offset"] || seg[:offset] || 0).to_f %>
          <% detail = (seg["detail"] || seg[:detail]).to_s %>
          <% source = seg["source"] || seg[:source] %>
          <% bar_color = type == "sql" ? "#1f6feb" : type == "view" ? "#8957e5" : "#484f58" %>
          <% left_pct = (offset / total_dur * 100).clamp(0, 99) %>
          <% width_pct = (dur / total_dur * 100).clamp(0.5, 100 - left_pct) %>

          <tr>
            <td class="mono" style="color:#484f58"><%= i + 1 %></td>
            <td><span class="badge badge-<%= type %>"><%= type %></span></td>
            <td class="mono" style="text-align:right"><%= "%.2f" % dur %>ms</td>
            <td class="mono" style="text-align:right;color:#484f58"><%= "%.0f" % offset %>ms</td>
            <td>
              <% if type == "sql" && detail.length > 80 %>
                <div class="sql-text sql-expandable" onclick="this.classList.toggle('expanded')" title="Click to expand"><%= detail %></div>
              <% elsif type == "sql" %>
                <div class="sql-text"><%= detail %></div>
              <% else %>
                <div class="mono"><%= detail %></div>
              <% end %>
              <% if source %>
                <div class="source"><%= source %></div>
              <% end %>
            </td>
            <td>
              <div class="bar-container">
                <div class="bar-fill" style="margin-left:<%= left_pct %>%; width:<%= width_pct %>%; background:<%= bar_color %>"></div>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

<% else %>
  <h2>Segments</h2>
  <div class="empty">No segments captured for this request.</div>
<% end %>

<%# ─── Raw Context ─── %>
<h2>Raw Context</h2>
<div style="background:#161b22; border:1px solid #30363d; border-radius:8px; padding:14px; overflow-x:auto">
  <pre class="mono" style="color:#8b949e; white-space:pre-wrap"><%= JSON.pretty_generate(@context.except("segments", :segments)) rescue @context.inspect %></pre>
</div>
