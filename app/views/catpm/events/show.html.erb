<% content_for :title, @name %>
<% content_for :subtitle, "Event Detail" %>

<%= render "catpm/shared/page_nav", active: "events" %>

<div class="breadcrumbs" style="display:flex; align-items:center; justify-content:space-between">
  <div>
    <a href="<%= catpm.events_path(range: @range) %>">Events</a>
    <span class="sep">/</span>
    <span class="badge badge-event"><%= @name %></span>
  </div>
  <div style="display:flex; gap:6px; align-items:center">
    <%= button_to @pref&.ignored ? "Unignore" : "Ignore", catpm.event_ignore_path(name: @name),
        method: :patch, class: "btn" %>
    <%= button_to "Delete Event", catpm.event_path(name: @name),
        method: :delete, class: "btn btn-danger",
        data: { confirm: "Delete this event and all its data? This cannot be undone." } %>
  </div>
</div>

<%# ─── Time Range ─── %>
<div class="time-range">
  <% (["all"] + Catpm::ApplicationHelper::RANGE_KEYS).each do |r| %>
    <a href="<%= catpm.event_path(name: @name, range: r) %>" class="<%= 'active' if @range == r %>"><%= r == "all" ? "All" : r %></a>
  <% end %>
</div>

<%# ─── Hero Metrics ─── %>
<div class="grid-hero">
  <div class="card">
    <div class="label">Total Count</div>
    <div class="value"><%= @total_count %></div>
    <div class="detail"><%= range_label(@range) %></div>
  </div>
  <div class="card">
    <div class="label">Events / min</div>
    <div class="value"><%= @events_per_min %></div>
    <div class="detail"><%= range_label(@range) %></div>
  </div>
  <div class="card">
    <div class="label">Last Seen</div>
    <div class="value" style="font-size:18px"><%= @last_seen ? time_with_tooltip(@last_seen) : "—" %></div>
  </div>
</div>

<% if @chart_data&.any? { |v| v > 0 } %>
  <div class="charts-row">
    <div class="chart-card">
      <div class="label">Event Volume</div>
      <div class="value"><%= @chart_data.sum %></div>
      <div class="detail"><%= range_label(@range) %></div>
      <div class="sparkline"><%= sparkline_svg(@chart_data, width: 500, height: 64, color: "var(--accent)", fill: true, time_labels: @chart_times) %></div>
    </div>
  </div>
<% end %>

<%# ─── Recent Samples ─── %>
<h2>Recent Samples</h2>
<%= section_description("Most recent event payloads captured.") %>

<% if @samples.any? %>
  <table style="table-layout:fixed">
    <colgroup>
      <col style="width:120px">
      <col>
      <col style="width:36px">
    </colgroup>
    <thead>
      <tr>
        <th>Recorded At</th>
        <th>Payload</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @samples.each do |sample| %>
        <tr>
          <td style="white-space:nowrap; vertical-align:top"><%= time_with_tooltip(sample.recorded_at) %></td>
          <td style="vertical-align:top">
            <% payload = sample.parsed_payload %>
            <% if payload.any? %>
              <details class="collapsible-compact">
                <summary><%= payload.keys.first(3).join(", ") %><%= "..." if payload.keys.size > 3 %></summary>
                <div class="details-body">
                  <pre style="font-size:12px; white-space:pre-wrap; word-break:break-all; margin:0"><%= JSON.pretty_generate(payload) %></pre>
                </div>
              </details>
            <% else %>
              <span class="text-muted">—</span>
            <% end %>
          </td>
          <td style="position:relative; z-index:2; width:28px; padding:4px 2px; text-align:center; vertical-align:top">
            <button class="action-menu-btn">&#x22EE;</button>
            <div class="action-menu">
              <button class="menu-danger" data-action="delete" data-url="<%= catpm.destroy_sample_events_path(sample_id: sample.id) %>">Delete</button>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <div class="empty-state">
    <div class="empty-title">No samples recorded</div>
    <div class="empty-hint">Events without payloads don't generate samples.</div>
  </div>
<% end %>
