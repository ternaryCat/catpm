<% content_for :title, @error.error_class %>
<% content_for :subtitle do %>
  <%= type_badge(@error.kind) %>
  <%= @error.error_class %>
  &middot; <%= @error.occurrences_count %> occurrences
<% end %>

<%= render "catpm/shared/page_nav", active: "errors" %>

<div class="breadcrumbs">
  <a href="<%= catpm.errors_path(tab: @error.resolved? ? "resolved" : "active") %>">Errors</a>
  <span class="sep">/</span>
  <span><%= @error.error_class %></span>
</div>

<%# ─── Hero ─── %>
<div class="error-hero">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:12px">
    <div style="flex:1; min-width:0">
      <div class="error-hero-class"><%= @error.error_class %></div>
      <div class="error-hero-message"><%= @error.message %></div>
      <div class="error-hero-meta">
        <%= type_badge(@error.kind) %>
        <%= status_dot(@error.resolved?) %>
        <span class="occurrence-count"><%= @error.occurrences_count %> occurrences</span>
      </div>
    </div>
    <div style="display:flex; gap:6px; flex-shrink:0">
      <% if @error.resolved? %>
        <%= button_to "Reopen", catpm.unresolve_error_path(@error), method: :patch, class: "btn" %>
      <% else %>
        <%= button_to "Resolve", catpm.resolve_error_path(@error), method: :patch, class: "btn btn-primary" %>
      <% end %>
      <%= button_to "Delete", catpm.error_path(@error), method: :delete, class: "btn btn-danger", data: { confirm: "Delete this error and all its occurrences?" } %>
    </div>
  </div>
</div>

<%# ─── Timeline ─── %>
<div class="grid">
  <div class="card">
    <div class="label">First Seen</div>
    <div class="value" style="font-size:16px"><%= time_with_tooltip(@error.first_occurred_at) %></div>
  </div>
  <div class="card">
    <div class="label">Last Seen</div>
    <div class="value" style="font-size:16px"><%= time_with_tooltip(@error.last_occurred_at) %></div>
  </div>
</div>

<%# ─── Error Frequency Chart ─── %>
<div class="time-range">
  <% (["all"] + Catpm::ApplicationHelper::RANGE_KEYS).each do |r| %>
    <a href="<%= catpm.error_path(@error, range: r) %>" class="<%= 'active' if @range == r %>"><%= r == "all" ? "All" : r %></a>
  <% end %>
</div>

<% if @chart_data&.any? { |v| v > 0 } %>
  <div class="charts-row">
    <div class="chart-card">
      <div class="label">Error Frequency</div>
      <div class="value"><%= @chart_data.sum %></div>
      <div class="detail">occurrences &middot; <%= range_label(@range) %></div>
      <div class="sparkline"><%= sparkline_svg(@chart_data, width: 500, height: 64, color: "var(--red)", fill: true, time_labels: @chart_times) %></div>
    </div>
  </div>
<% end %>

<%# ─── Backtrace ─── %>
<% first_bt = @contexts.first && (@contexts.first["backtrace"] || @contexts.first[:backtrace] || []) %>
<% if first_bt.any? %>
  <h2>Backtrace</h2>
  <%= section_description("All occurrences share the same fingerprint and backtrace.") %>
  <div style="border:1px solid var(--border); border-radius:var(--radius); padding:14px; margin-bottom:12px; position:relative">
    <button class="copy-btn" style="position:absolute; top:8px; right:8px" onclick="copyText(this)">Copy</button>
    <% preview_lines = first_bt.first(10) %>
    <% remaining_lines = first_bt.drop(10) %>
    <pre class="mono" style="font-size:12px; white-space:pre-wrap; margin:0; line-height:1.8"><% preview_lines.each do |line| %><span class="<%= line.match?(%r{/(gems|ruby|vendor|bundle)/}) ? 'backtrace-lib' : 'backtrace-app' %>"><%= line %></span>
<% end %></pre>
    <% if remaining_lines.any? %>
      <details style="margin-top:4px">
        <summary style="cursor:pointer; font-size:12px; color:var(--text-2)">Show full backtrace (<%= first_bt.size %> lines)</summary>
        <pre class="mono" style="font-size:12px; white-space:pre-wrap; margin:0; line-height:1.8"><% remaining_lines.each do |line| %><span class="<%= line.match?(%r{/(gems|ruby|vendor|bundle)/}) ? 'backtrace-lib' : 'backtrace-app' %>"><%= line %></span>
<% end %></pre>
      </details>
    <% end %>
  </div>
<% end %>

<%# ─── Fingerprint ─── %>
<div style="margin-bottom:20px; font-size:12px; color:var(--text-2)">
  <span style="font-weight:500; color:var(--text-1)">Fingerprint:</span>
  <span class="mono" style="word-break:break-all"><%= @error.fingerprint %></span>
</div>

<%# ─── Samples ─── %>
<% if @samples.any? %>
  <h2>Recent Samples</h2>
  <%= section_description("Linked request samples for this error. Click to view full details.") %>
  <div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Duration</th>
        <th>Status</th>
        <th>Target</th>
        <th>Segments</th>
      </tr>
    </thead>
    <tbody>
      <% @samples.each do |sample| %>
        <% ctx = sample.parsed_context %>
        <tr class="clickable-row" onclick="window.location='<%= catpm.sample_path(sample) %>';" style="cursor:pointer">
          <td><%= time_with_tooltip(sample.recorded_at) %></td>
          <td class="mono"><%= format_duration(sample.duration) %></td>
          <td><%= status_badge(ctx["status"] || ctx[:status]) %></td>
          <td class="mono"><%= sample.bucket&.target || "—" %></td>
          <td class="mono text-muted"><%= segment_count_summary(ctx["segment_summary"] || ctx[:segment_summary]).presence || "—" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  </div>
<% end %>

<%# ─── Legacy Occurrences (for errors without linked samples) ─── %>
<% if @samples.empty? && @contexts.any? %>
  <h2>Last <%= @contexts.size %> Captured Occurrences</h2>
  <div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Duration</th>
        <th>Status</th>
        <th>Target</th>
      </tr>
    </thead>
    <tbody>
      <% @contexts.each do |ctx| %>
        <tr>
          <td><%= time_with_tooltip(ctx["occurred_at"] || ctx[:occurred_at]) %></td>
          <td class="mono"><%= (ctx["duration"] || ctx[:duration]) ? format_duration((ctx["duration"] || ctx[:duration]).to_f) : "—" %></td>
          <td><%= status_badge(ctx["status"] || ctx[:status]) %></td>
          <td class="mono"><%= ctx["target"] || ctx[:target] || "—" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  </div>
<% end %>
